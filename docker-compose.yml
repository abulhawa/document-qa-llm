services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  embedder-api:
    build:
      context: ./embedder_api_multilingual
    ports:
      - "8000:8000"
    env_file: ./embedder_api_multilingual/.env
    volumes:
      - hf_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  phoenix:
    image: arizephoenix/phoenix:latest
    ports:
      - "6006:6006"
      - "4317:4317"
    volumes:
      - phoenix_data:/root/.phoenix
    environment:
      - PHOENIX_SERVER_PORT=6006

  opensearch:
    image: opensearchproject/opensearch:3.1.0
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - DISABLE_INSTALL_DEMO_CONFIG=true # Prevents execution of bundled demo script which installs demo certificates and security configurations to OpenSearch
      - DISABLE_SECURITY_PLUGIN=true # Disables Security plugin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"
    networks:
      - opensearch-net

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3.1.0
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    expose:
      - "5601"
    networks:
      - opensearch-net
    depends_on:
      - opensearch

  redis:
    image: redis:8.2.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  celery:
    build:
      context: .
      dockerfile: worker/Dockerfile
    depends_on:
      - redis
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - EMBEDDING_API_URL=http://embedder-api:8000/embed
      - QDRANT_URL=http://qdrant:6333
    volumes:
      - .:/app
      - celery_worker_logs:/app/logs

  flower:
      image: mher/flower:latest
      depends_on:
        - redis
      environment:
        - CELERY_BROKER_URL=redis://redis:6379/0
      ports:
        - "5555:5555"
    
volumes:
  qdrant_data:
  phoenix_data:
  opensearch-data:
  hf_cache:
  celery_worker_logs:
  redis-data:

networks:
  opensearch-net: