services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks: [appnet]

  embedder-api:
    build:
      context: ./embedder_api_multilingual
    ports:
      - "8000:8000"
    env_file: ./embedder_api_multilingual/.env
    volumes:
      - hf_cache:/root/.cache/huggingface
    environment:
      - EMBEDDING_BATCH_SIZE=96
      - EMBEDDING_DEVICE=cuda
      - EMBEDDING_FP16=true
      - UVICORN_WORKERS=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks: [appnet]

  phoenix:
    image: arizephoenix/phoenix:latest
    ports:
      - "6006:6006"
      - "4317:4317"
    volumes:
      - phoenix_data:/root/.phoenix
    environment:
      - PHOENIX_SERVER_PORT=6006
    networks: [appnet]

  opensearch:
    image: opensearchproject/opensearch:3.2.0
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
      - path.repo=/mnt/opensearch-backups
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data
      - ./opensearch-backups:/mnt/opensearch-backups
    ports:
      - "9200:9200"
      - "9600:9600"
    networks: [appnet]

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3.2.0
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    expose:
      - "5601"
    depends_on:
      - opensearch
    networks: [appnet]

  redis:
    image: redis:8.2.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks: [appnet]

  celery:
    build:
      context: .
      dockerfile: worker/Dockerfile
    depends_on:
      - redis
      - opensearch
      - qdrant
      - embedder-api
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - DOC_PATH_MAP=C:/=>/host-c
      - EMBEDDING_API_URL=http://embedder-api:8000/embed
      # Larger request groups + batch size to push more work per API call
      - EMBEDDING_REQ_MAX_CHUNKS=192
      - EMBEDDING_BATCH_SIZE=96
      - QDRANT_URL=http://qdrant:6333
      - OPENSEARCH_URL=http://opensearch:9200
    volumes:
      - "C:/:/host-c:ro"
    networks: [appnet]
    command: >
      celery -A worker.celery_worker:app worker
      -Ofair
      --autoscale=16,8
      --prefetch-multiplier=1
      --max-tasks-per-child=200
      -l INFO

  flower:
    image: mher/flower:latest
    depends_on:
      - redis
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - FLOWER_UNAUTHENTICATED_API=true
    ports:
      - "5555:5555"
    networks: [appnet]

volumes:
  qdrant_data:
  phoenix_data:
  opensearch-data:
  hf_cache:
  celery_worker_logs:
  redis-data:

networks:
  appnet: {}
